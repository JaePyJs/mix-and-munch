// This is the COMPLETE Prisma schema for Mix & Munch
// Copy this into prisma/schema.prisma in your Next.js project

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============================================================================
// USERS & AUTHENTICATION
// ============================================================================

model User {
  id                    String      @id @default(cuid())
  email                 String      @unique
  name                  String?
  password              String?     // null if OAuth
  avatar                String?
  role                  Role        @default(USER)
  
  // Preferences
  dietaryRestrictions   String[]    @default([]) // vegan, keto, vegetarian, etc
  allergies             String[]    @default([]) // nuts, dairy, gluten, etc
  cuisinePrefs          String[]    @default([]) // Filipino, Asian, European, etc
  preferredLanguage     String      @default("en") // en, tl (Tagalog)
  
  // Account status
  emailVerified         DateTime?
  isActive              Boolean     @default(true)
  
  // Relationships
  recipes               Recipe[]    @relation("author")
  reviews               Review[]
  favorites             Favorite[]
  shoppingLists         ShoppingList[]
  mealPlans             MealPlan[]
  pantryItems           PantryItem[]
  communityPosts        CommunityPost[]
  sessions              Session[]
  auditLogs             AuditLog[]  @relation("user")
  
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt

  @@index([email])
}

model Session {
  id            String   @id @default(cuid())
  sessionToken  String   @unique
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expires       DateTime
  createdAt     DateTime @default(now())

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================================================
// RECIPES & CONTENT
// ============================================================================

model Recipe {
  id                String      @id @default(cuid())
  
  // Basic info
  title             String
  description       String?
  cuisine           String      // Filipino, Asian, etc
  difficulty        String      @default("medium") // easy, medium, hard
  tags              String[]    @default([]) // soup, dessert, quick, etc
  
  // Content
  ingredients       String      // JSON array: [{ name, quantity, unit }]
  instructions      String      // JSON array: [{ step, duration }]
  images            String[]    @default([]) // URLs to images
  videoUrl          String?
  
  // Metadata
  prepTime          Int?        // minutes
  cookTime          Int?        // minutes
  servings          Int?        // number of servings
  calories          Int?        // per serving
  yieldAmount       String?     // "2 cups" etc
  
  // Publishing
  status            RecipeStatus @default(DRAFT)
  isPublic          Boolean     @default(true)
  sourceUrl         String?     // if from crawler
  sourceSite        String?     // panlasang-pinoy, kawaling-pinoy, etc
  
  // Relationships
  author            User?       @relation("author", fields: [authorId], references: [id], onDelete: SetNull)
  authorId          String?
  reviews           Review[]
  favorites         Favorite[]
  mealPlanItems     MealPlanItem[]
  communityPosts    CommunityPost[]
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@index([authorId])
  @@index([cuisine])
  @@index([difficulty])
  @@index([sourceUrl])
}

model Review {
  id        String   @id @default(cuid())
  rating    Int      // 1-5
  comment   String?
  helpful   Int      @default(0) // count of helpful votes
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  recipe    Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  recipeId  String
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, recipeId])
  @@index([userId])
  @@index([recipeId])
}

model Favorite {
  id        String   @id @default(cuid())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  recipe    Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  recipeId  String
  
  createdAt DateTime @default(now())

  @@unique([userId, recipeId])
  @@index([userId])
}

// ============================================================================
// PANTRY & SHOPPING
// ============================================================================

model PantryItem {
  id        String   @id @default(cuid())
  
  name      String
  quantity  String?  // "1" or "2.5"
  unit      String?  // "kg", "cup", "liter", "piece"
  category  String?  // "produce", "meat", "dairy", etc
  expiryDate DateTime?
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model ShoppingList {
  id        String   @id @default(cuid())
  
  name      String   @default("Shopping List")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  items     ShoppingItem[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model ShoppingItem {
  id        String   @id @default(cuid())
  
  name      String
  quantity  String?
  unit      String?  // kg, cup, etc
  category  String?  // produce, dairy, meat
  isChecked Boolean  @default(false)
  price     Float?   // optional price tracking
  
  list      ShoppingList @relation(fields: [listId], references: [id], onDelete: Cascade)
  listId    String
  
  createdAt DateTime @default(now())

  @@index([listId])
}

// ============================================================================
// MEAL PLANNING
// ============================================================================

model MealPlan {
  id        String   @id @default(cuid())
  
  name      String   @default("My Meal Plan")
  startDate DateTime
  endDate   DateTime
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  meals     MealPlanItem[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model MealPlanItem {
  id        String   @id @default(cuid())
  
  date      DateTime
  mealType  String   // breakfast, lunch, dinner, snack
  notes     String?
  servings  Int      @default(1)
  
  recipe    Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  recipeId  String
  plan      MealPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  planId    String
  
  createdAt DateTime @default(now())

  @@unique([planId, date, mealType])
  @@index([planId])
  @@index([recipeId])
}

// ============================================================================
// COMMUNITY
// ============================================================================

model CommunityPost {
  id        String   @id @default(cuid())
  
  caption   String?
  isPublic  Boolean  @default(true)
  isReported Boolean @default(false)
  likes     Int      @default(0)
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  recipe    Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  recipeId  String
  comments  Comment[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([recipeId])
}

model Comment {
  id        String   @id @default(cuid())
  
  text      String
  
  post      CommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId    String
  
  createdAt DateTime @default(now())

  @@index([postId])
}

// ============================================================================
// DATA INGESTION
// ============================================================================

model CrawledRecipe {
  id        String   @id @default(cuid())
  
  sourceUrl String   @unique
  sourceSite String  // panlasang-pinoy, kawaling-pinoy, lutong-bahay, etc
  rawData   String   // JSON of scraped data
  
  // Link to imported recipe if created
  parsedRecipeId String?
  
  // Crawler status
  status    CrawlStatus @default(PENDING)
  errorMsg  String?
  
  // Tracking
  attempts  Int      @default(1)
  lastAttempt DateTime @default(now())
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([sourceSite])
}

model YouTubeVideo {
  id        String   @id @default(cuid())
  
  videoId   String   @unique
  title     String
  channelName String
  channelId String?
  thumbnail String?
  
  // Transcript & extraction
  transcript String?
  extractedRecipeId String?
  
  // Status
  status    CrawlStatus @default(PENDING)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([channelId])
  @@index([status])
}

// ============================================================================
// ADMIN & MODERATION
// ============================================================================

model Report {
  id        String   @id @default(cuid())
  
  type      String   // recipe, comment, post, user
  targetId  String   // ID of reported item
  reason    String
  status    ReportStatus @default(PENDING)
  
  reportedBy String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([type])
}

model AuditLog {
  id        String   @id @default(cuid())
  
  action    String   // created, updated, deleted, published, etc
  entity    String   // Recipe, User, Comment, etc
  targetId  String
  
  user      User?    @relation("user", fields: [userId], references: [id], onDelete: SetNull)
  userId    String?
  
  details   String?  // JSON of changes
  ipAddress String?
  
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([entity])
}

// ============================================================================
// ENUMS
// ============================================================================

enum Role {
  USER
  MODERATOR
  ADMIN
}

enum RecipeStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
  FLAGGED
}

enum CrawlStatus {
  PENDING
  SUCCESS
  FAILED
  DUPLICATE
  PROCESSING
}

enum ReportStatus {
  PENDING
  REVIEWING
  RESOLVED
  DISMISSED
  ESCALATED
}
